# Dynamic Spec

We need to be able to dynamically build
[Ceph spec files](https://docs.ceph.com/en/latest/mgr/orchestrator/#host-specification)
within TripleO via two Ansible modules

## Full Spec Module for Create

As per the design documents for the 
[ceph spec](https://specs.openstack.org/openstack/tripleo-specs/specs/wallaby/tripleo-ceph.html#requirements-for-deploying-ceph-before-overcloud-deployment)
and 
[inventory](https://specs.openstack.org/openstack/tripleo-specs/specs/wallaby/tripleo-ceph.html#ansible-inventory-and-ansible-user),
we can use 
deployed-metal-<stack>.yaml (the [output](https://docs.openstack.org/project-deploy-guide/tripleo-docs/latest/provisioning/baremetal_provision.html#deploying-the-overcloud) of `openstack overcloud node provision --output deployed-metal-<stack>.yaml`) 
and
[roles_data.yaml](https://github.com/openstack/tripleo-heat-templates/blob/master/roles_data.yaml)
as input to an Ansible module to determine what services are needed 
per role and then build a 
[ceph spec file](https://docs.ceph.com/en/latest/mgr/orchestrator/#host-specification)
which mapped ceph services to those hosts.

## Partial Spec Module for Update

There are times when the full spec cannot be applied at once so parts
of it need to be applied after the Ceph cluster has reached a certain
state. For example, when configuring MDS you apply enough of a spec to
get the minimal Ceph cluster running, run some commands with Ansible
for CephFS, and then apply another part of the spec. E.g. the WIP
patch for [mds.yaml](https://review.opendev.org/c/openstack/tripleo-ansible/+/773364/23/tripleo_ansible/roles/tripleo_cephadm/tasks/mds.yaml).
This is also known as the "distributed" approach as the spec is broken
apart.

## Shared Library

Both of these modules will use a shared library which will live in 
[tripleo-ansible's module_utils](https://github.com/openstack/tripleo-ansible/tree/master/tripleo_ansible/ansible_plugins/module_utils) and
be introduced by a single patch. The two modules can then be developed
in independent patches and re-based on that first patch and the 
[scenario004 patch](https://review.opendev.org/c/openstack/tripleo-ansible/+/773364)
can be rebased on the partial spec module.

## POCs

The [mkspec.py](mkspec.py) in this directory is taken from 
[fmount's mkspec.py](https://github.com/fmount/tripleo-wallaby/blob/master/scripts/mkspec.py) and
it represents what will grow into the shared library.

The [use_spec.py](use_spec.py) in this directory will grow into 
the full spec module.

## Using use_spec.py

```
  ./use_spec.py -m metal.yaml
  cat ceph_spec.yml
```

The above will create `ceph_spec.yml` which is similar to
"spec_out/minimal" as generated by the 
[minimal test case](https://github.com/fmount/tripleo-wallaby/blob/master/scripts/test.sh#L48).
