---
- name: Add spec to necessary file list when using spec to bootstrap
  set_fact:
    bootstrap_files: "{{ bootstrap_files + [ ceph_spec ] }}"
  when: spec_on_bootstrap

- name: Stat necessary files to bootstrap with cephadm
  stat:
    path: "{{ item }}"
  register: stat_cephadm_bootstrap_files
  become: true
  loop: "{{ bootstrap_files }}"

- name: Fail if necessary files are missing
  fail:
    msg: "{{ item.invocation.module_args.path }} does not exist"
  loop: "{{ stat_cephadm_bootstrap_files.results | list }}"
  when: not item.stat.exists

# cephadm_ls should be registered by pre.yaml

- name: Bootstrap Ceph if there are no running Ceph Daemons
  block:
      # items to add
      #   --registry-json
      #   --config (optional)
    - name: Run cephadm bootstrap
      shell: |
        {{ cephadm_bin }} bootstrap \
        --skip-firewalld \
        --ssh-private-key /home/{{ ceph_ssh_user }}/.ssh/id_rsa \
        --ssh-public-key /home/{{ ceph_ssh_user }}/.ssh/id_rsa.pub \
        --ssh-user {{ ceph_ssh_user }} \
        --output-keyring {{ admin_keyring }} \
        --output-config {{ ceph_conf }} \
        --fsid {{ fsid }} \
        {% if spec_on_bootstrap %}--apply-spec {{ ceph_spec }} \{% endif %}
        --mon-ip {{ first_mon_ip }}
      register: cephadm_bootstrap
      become: true
    - name: Show results of bootstrap
      debug:
        msg: "{{ cephadm_bootstrap }}"
      when: verbose
  when:
    - cephadm_ls.stdout == '[]'

- name: If cephadm bootstrap was not run report the reason
  debug:
    msg: |
      'cephadm bootstrap' was not run because 'cephadm ls'
      indicates that Ceph containers are already running.
  when:
    - cephadm_ls.stdout != '[]'
