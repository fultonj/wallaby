---
- name: Stat spec file on bootstrap node
  stat:
    path: "{{ item }}"
  register: stat_ceph_spec_files
  become: true
  loop:
    - "{{ ceph_spec }}"

- name: Fail if spec file is missing
  fail:
    msg: "{{ item.invocation.module_args.path }} does not exist"
  loop: "{{ stat_ceph_spec_files.results | list }}"
  when: not item.stat.exists

- name: Get ceph_cli
  include_tasks: ceph_cli.yaml
  vars:
    mount_spec: true

- name: Get the ceph orchestrator status
  command: "{{ ceph_cli }} orch status --format json"
  register: ceph_orch_status
  become: true

- name: Fail if ceph orchestrator is not available
  fail:
    msg: "'ceph orch status' returned {{ ceph_orch_status.stdout | from_json }}"
  when: 
    - not (ceph_orch_status.stdout | from_json).available

- name: Apply spec
  command: "{{ ceph_cli }} orch apply --in-file {{ container_ceph_spec }}"
  register: ceph_spec_apply_output
  become: true

- name: Show results of spec apply
  debug:
    msg: "{{ ceph_spec_apply_output }}"
  when: verbose
