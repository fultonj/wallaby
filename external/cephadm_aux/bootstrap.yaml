---
- name: Stat necessary files to bootstrap with cephadm
  stat:
    path: "{{ item }}"
  register: stat_cephadm_bootstrap_files
  become: true
  loop:
    - "/home/{{ ceph_ssh_user }}/.ssh/id_rsa"
    - "/home/{{ ceph_ssh_user }}/.ssh/id_rsa.pub"
    - "{{ cephadm_bin }}"
- name: Fail if necessary files are missing
  fail:
    msg: "{{ item.invocation.module_args.path }} does not exist"
  loop: "{{ stat_cephadm_bootstrap_files.results | list }}"
  when: not item.stat.exists

- name: List Ceph daemon instances on this host
  shell: |
    {{ cephadm_bin }} ls --no-detail
  register: cephadm_ls
  become: true

- name: Bootstrap Ceph if there are no running Ceph Daemons
  block:
      # items to add
      #   --registry-json
      #   --config (optional)
      #   --apply-spec (optional)
    - name: Run cephadm bootstrap
      shell: |
        {{ cephadm_bin }} bootstrap \
        --skip-firewalld \
        --ssh-private-key /home/{{ ceph_ssh_user }}/.ssh/id_rsa \
        --ssh-public-key /home/{{ ceph_ssh_user }}/.ssh/id_rsa.pub \
        --ssh-user {{ ceph_ssh_user }} \
        --output-keyring {{ admin_keyring }} \
        --output-config {{ ceph_conf }} \
        --fsid {{ fsid }} \
        --mon-ip {{ first_mon_ip }}
      register: cephadm_bootstrap
      become: true
    - name: Show results of bootstrap
      debug:
        msg: "{{ cephadm_bootstrap }}"
  when:
    - cephadm_ls.stdout == '[]'
